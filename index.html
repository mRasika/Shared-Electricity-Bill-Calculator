<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Calculate and split shared electricity bills among multiple shops fairly">
  <title>Shared Electricity Bill Calculator</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- html2pdf.js for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.ico">
  
  <style>
    :root {
      --primary-bg: #ffffff;
      --secondary-bg: #f8f9fa;
      --text-color: #212529;
      --border-color: #dee2e6;
      --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode {
      --primary-bg: #121212;
      --secondary-bg: #1e1e1e;
      --text-color: #f1f1f1;
      --border-color: #444;
      --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    body {
      background-color: var(--primary-bg);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .form-control,
    .form-select {
      background-color: var(--primary-bg);
      color: var(--text-color);
      border-color: var(--border-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    .dark-mode .form-control,
    .dark-mode .form-select {
      background-color: var(--secondary-bg);
      color: var(--text-color);
      border-color: var(--border-color);
    }

    .dark-mode .form-control:focus,
    .dark-mode .form-select:focus {
      background-color: var(--secondary-bg);
      color: var(--text-color);
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .shop-block {
      background: var(--secondary-bg);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .shop-input-group {
      background: var(--secondary-bg);
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .remove-shop-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .logo {
      max-width: 80px;
      margin-bottom: 0.625rem;
    }

    .header-section {
      padding: 1.5rem 0;
      margin-bottom: 1rem;
    }

    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .dark-mode .summary-card {
      background: linear-gradient(135deg, #434343 0%, #000000 100%);
    }

    .form-switch .form-check-input {
      cursor: pointer;
    }

    footer {
      margin-top: 2.5rem;
      padding: 1rem;
      text-align: center;
      font-size: 0.875rem;
      color: #888;
      border-top: 1px solid var(--border-color);
    }

    .dark-mode footer {
      color: #aaa;
    }

    .btn-calculate {
      padding: 0.75rem 2rem;
      font-size: 1.1rem;
    }

    .validation-error {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .result-highlight {
      font-size: 1.25rem;
      font-weight: bold;
      color: #198754;
    }

    .dark-mode .result-highlight {
      color: #75b798;
    }

    @media print {
      .no-print {
        display: none !important;
      }
      .shop-block {
        break-inside: avoid;
      }
    }

    /* Export buttons styling */
    .export-buttons {
      display: none;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed var(--border-color);
    }

    .export-buttons.show {
      display: flex;
    }

    .btn-whatsapp {
      background-color: #25D366;
      border-color: #25D366;
      color: white;
    }

    .btn-whatsapp:hover {
      background-color: #128C7E;
      border-color: #128C7E;
      color: white;
    }

    .btn-pdf {
      background-color: #DC3545;
      border-color: #DC3545;
      color: white;
    }

    .btn-pdf:hover {
      background-color: #BB2D3B;
      border-color: #BB2D3B;
      color: white;
    }

    /* PDF export specific styling */
    .pdf-header {
      text-align: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #667eea;
    }

    .pdf-footer {
      text-align: center;
      margin-top: 1rem;
      padding-top: 0.5rem;
      font-size: 0.8rem;
      color: #666;
      border-top: 1px solid #ddd;
    }

    /* Loading spinner for PDF */
    .btn-loading {
      position: relative;
      pointer-events: none;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 1rem;
      height: 1rem;
      top: 50%;
      left: 50%;
      margin-left: -0.5rem;
      margin-top: -0.5rem;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <!-- Header Section -->
    <header class="header-section text-center">
      <img src="logo.png" alt="Electricity Calculator Logo" class="logo" onerror="this.style.display='none'">
      <h1 id="title" class="h2"><i class="bi bi-lightning-charge"></i> Shared Electricity Bill Calculator</h1>
    </header>

    <!-- Settings Bar -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 no-print">
      <div class="d-flex align-items-center gap-2">
        <label for="languageSelect" class="form-label mb-0">
          <i class="bi bi-globe"></i> <span data-i18n="language">Language</span>:
        </label>
        <select id="languageSelect" class="form-select form-select-sm w-auto" aria-label="Select language">
          <option value="en">English</option>
          <option value="si">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</option>
        </select>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="darkToggle" role="switch" aria-label="Toggle dark mode">
        <label class="form-check-label" for="darkToggle">
          <i class="bi bi-moon-stars"></i> <span data-i18n="darkMode">Dark Mode</span>
        </label>
      </div>
    </div>

    <!-- Main Form -->
    <form id="calculatorForm" novalidate>
      <!-- Bill Details -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label for="totalBill" class="form-label" data-i18n="totalBill">Total Bill (LKR)</label>
          <div class="input-group">
            <span class="input-group-text">Rs.</span>
            <input type="number" id="totalBill" class="form-control" value="2400" min="0" step="0.01" required aria-describedby="totalBillHelp">
          </div>
          <div id="totalBillHelp" class="form-text" data-i18n="totalBillHelp">Enter the total electricity bill amount</div>
        </div>
        <div class="col-md-6">
          <label for="fixedCharge" class="form-label" data-i18n="fixedCharge">Fixed Charge (LKR)</label>
          <div class="input-group">
            <span class="input-group-text">Rs.</span>
            <input type="number" id="fixedCharge" class="form-control" value="500" min="0" step="0.01" required aria-describedby="fixedChargeHelp">
          </div>
          <div id="fixedChargeHelp" class="form-text" data-i18n="fixedChargeHelp">Fixed charges from your bill</div>
        </div>
      </div>

      <!-- Split Method -->
      <div class="mb-4">
        <label for="splitMethod" class="form-label" data-i18n="splitMethod">Fixed Charge Split Method</label>
        <select id="splitMethod" class="form-select" aria-describedby="splitMethodHelp">
          <option value="equal" data-i18n="equal">Equal Split</option>
          <option value="proportional" data-i18n="proportional">Proportional Split (by usage)</option>
        </select>
        <div id="splitMethodHelp" class="form-text" data-i18n="splitMethodHelp">Choose how to divide the fixed charges</div>
      </div>

      <!-- Shop Inputs -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0" data-i18n="shopUnits"><i class="bi bi-shop"></i> Shop Units</h5>
          <button type="button" class="btn btn-outline-primary btn-sm" id="addShopBtn" data-i18n="addShop">
            <i class="bi bi-plus-circle"></i> Add Shop
          </button>
        </div>
        <div id="shopInputs"></div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2 flex-wrap mb-4 no-print">
        <button type="submit" class="btn btn-success btn-calculate" data-i18n="calculate">
          <i class="bi bi-calculator"></i> Calculate
        </button>
        <button type="button" class="btn btn-outline-secondary" id="resetBtn" data-i18n="reset">
          <i class="bi bi-arrow-counterclockwise"></i> Reset
        </button>
        <button type="button" class="btn btn-outline-info" id="printBtn" data-i18n="print">
          <i class="bi bi-printer"></i> Print
        </button>
      </div>
    </form>

    <!-- Results Section -->
    <div id="output" class="result mt-4" role="region" aria-live="polite" aria-label="Calculation results"></div>

    <!-- Export Buttons (shown after calculation) -->
    <div id="exportButtons" class="export-buttons no-print">
      <button type="button" class="btn btn-pdf" id="exportPdfBtn" data-i18n="exportPdf">
        <i class="bi bi-file-earmark-pdf"></i> Export PDF
      </button>
      <button type="button" class="btn btn-whatsapp" id="shareWhatsappBtn" data-i18n="shareWhatsapp">
        <i class="bi bi-whatsapp"></i> Share on WhatsApp
      </button>
      <button type="button" class="btn btn-outline-primary" id="copyTextBtn" data-i18n="copyText">
        <i class="bi bi-clipboard"></i> Copy Text
      </button>
    </div>

    <!-- Footer -->
    <footer>
      <p class="mb-1">Developed with <i class="bi bi-heart-fill text-danger"></i> by Rasika</p>
      <a href="https://github.com/mRasika" target="_blank" rel="noopener noreferrer">
        <i class="bi bi-github"></i> GitHub Profile
      </a>
    </footer>
  </div>

  <script>
    // ============================================
    // Application State & Configuration
    // ============================================
    const APP_CONFIG = {
      currency: 'LKR',
      currencySymbol: 'Rs.',
      minShops: 1,
      maxShops: 20,
      defaultShops: [
        { name: 'Shop 1', units: 58 },
        { name: 'Shop 2', units: 17 },
        { name: 'Shop 3', units: 1 }
      ],
      storageKeys: {
        darkMode: 'electricityCalc_darkMode',
        language: 'electricityCalc_language',
        lastCalculation: 'electricityCalc_lastData'
      }
    };

    const translations = {
      en: {
        title: 'Shared Electricity Bill Calculator',
        language: 'Language',
        darkMode: 'Dark Mode',
        totalBill: 'Total Bill (LKR)',
        totalBillHelp: 'Enter the total electricity bill amount',
        fixedCharge: 'Fixed Charge (LKR)',
        fixedChargeHelp: 'Fixed charges from your bill',
        splitMethod: 'Fixed Charge Split Method',
        splitMethodHelp: 'Choose how to divide the fixed charges',
        equal: 'Equal Split',
        proportional: 'Proportional Split (by usage)',
        shopUnits: 'Shop Units',
        addShop: 'Add Shop',
        calculate: 'Calculate',
        reset: 'Reset',
        print: 'Print',
        shopName: 'Shop',
        units: 'Units',
        remove: 'Remove',
        totalUnits: 'Total Units',
        energyCostPerUnit: 'Energy Cost per Unit',
        unitsConsumed: 'Units Consumed',
        energyCost: 'Energy Cost',
        fixedChargeLabel: 'Fixed Charge',
        totalBillLabel: 'Total Bill',
        summary: 'Summary',
        errorInvalidBill: 'Please enter a valid bill amount',
        errorNoUnits: 'Please enter units for at least one shop',
        errorFixedCharge: 'Fixed charge cannot exceed total bill',
        exportPdf: 'Export PDF',
        shareWhatsapp: 'Share on WhatsApp',
        copyText: 'Copy Text',
        copied: 'Copied!',
        generating: 'Generating...',
        billSummary: 'Electricity Bill Summary',
        generatedOn: 'Generated on',
        verification: 'Verification'
      },
      si: {
        title: '‡∂∂‡∑ô‡∂Ø‡∑è‡∂ú‡∂≠‡∑ä ‡∑Ä‡∑í‡∂Ø‡∑î‡∂Ω‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ú‡∂´‡∂±‡∂∫',
        language: '‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä',
        darkMode: '‡∂Ö‡∂≥‡∑î‡∂ª‡∑î ‡∂∏‡∑è‡∂Ø‡∑í‡∂Ω‡∑í‡∂∫',
        totalBill: '‡∂∏‡∑î‡∑Ö‡∑î ‡∂∂‡∑í‡∂Ω (‡∂ª‡∑î.)',
        totalBillHelp: '‡∂∏‡∑î‡∑Ö‡∑î ‡∑Ä‡∑í‡∂Ø‡∑î‡∂Ω‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±',
        fixedCharge: '‡∑É‡∑ä‡∂Æ‡∑í‡∂ª ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä (‡∂ª‡∑î.)',
        fixedChargeHelp: '‡∂î‡∂∂‡∂ú‡∑ö ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ö ‡∑É‡∑ä‡∂Æ‡∑í‡∂ª ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î',
        splitMethod: '‡∑É‡∑ä‡∂Æ‡∑í‡∂ª ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î ‡∂∂‡∑ô‡∂Ø‡∑ì‡∂∏‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∂∏‡∂∫',
        splitMethodHelp: '‡∑É‡∑ä‡∂Æ‡∑í‡∂ª ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î ‡∂∂‡∑ô‡∂Ø‡∂± ‡∂Ü‡∂ö‡∑è‡∂ª‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±',
        equal: '‡∑É‡∂∏‡∑è‡∂± ‡∂∂‡∑ô‡∂Ø‡∑ì‡∂∏',
        proportional: '‡∂Ö‡∂±‡∑î‡∂¥‡∑è‡∂≠‡∑í‡∂ö ‡∂∂‡∑ô‡∂Ø‡∑ì‡∂∏ (‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∂∫ ‡∂Ö‡∂±‡∑î‡∑Ä)',
        shopUnits: '‡∑Ä‡∑ô‡∑Ö‡∂≥‡∑É‡∑ê‡∂Ω‡∑ä ‡∂í‡∂ö‡∂ö',
        addShop: '‡∑Ä‡∑ô‡∑Ö‡∂≥‡∑É‡∑ê‡∂Ω‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±',
        calculate: '‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±',
        reset: '‡∂∫‡∑Ö‡∑í ‡∂¥‡∑í‡∑Ñ‡∑í‡∂ß‡∑î‡∑Ä‡∂±‡∑ä‡∂±',
        print: '‡∂∏‡∑î‡∂Ø‡∑ä‚Äç‡∂ª‡∂´‡∂∫',
        shopName: '‡∑Ä‡∑ô‡∑Ö‡∂≥‡∑É‡∑ê‡∂Ω',
        units: '‡∂í‡∂ö‡∂ö',
        remove: '‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±',
        totalUnits: '‡∂∏‡∑î‡∑Ö‡∑î ‡∂í‡∂ö‡∂ö',
        energyCostPerUnit: '‡∂í‡∂ö‡∂ö‡∂∫‡∂ö‡∂ß ‡∂∂‡∂Ω‡∑Å‡∂ö‡∑ä‡∂≠‡∑í ‡∂¥‡∑í‡∂ª‡∑í‡∑Ä‡∑ê‡∂∫',
        unitsConsumed: '‡∂¥‡∂ª‡∑í‡∂∑‡∑ù‡∂¢‡∑í‡∂≠ ‡∂í‡∂ö‡∂ö',
        energyCost: '‡∂∂‡∂Ω‡∑Å‡∂ö‡∑ä‡∂≠‡∑í ‡∂¥‡∑í‡∂ª‡∑í‡∑Ä‡∑ê‡∂∫',
        fixedChargeLabel: '‡∑É‡∑ä‡∂Æ‡∑í‡∂ª ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä',
        totalBillLabel: '‡∂∏‡∑î‡∑Ö‡∑î ‡∂∂‡∑í‡∂Ω',
        summary: '‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫',
        errorInvalidBill: '‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±',
        errorNoUnits: '‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂ë‡∂ö‡∑ä ‡∑Ä‡∑ô‡∑Ö‡∂≥‡∑É‡∑ê‡∂Ω‡∂ö‡∂ß ‡∂í‡∂ö‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±',
        errorFixedCharge: '‡∑É‡∑ä‡∂Æ‡∑í‡∂ª ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä ‡∂∏‡∑î‡∑Ö‡∑î ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∂ß ‡∑Ä‡∂©‡∑è ‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö',
        exportPdf: 'PDF ‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±',
        shareWhatsapp: 'WhatsApp ‡∑Ñ‡∂ª‡∑Ñ‡∑è ‡∂∂‡∑ô‡∂Ø‡∑è‡∂ú‡∂±‡∑ä‡∂±',
        copyText: '‡∂¥‡∑í‡∂ß‡∂¥‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±',
        copied: '‡∂¥‡∑í‡∂ß‡∂¥‡∂≠‡∑ä ‡∂ö‡∑Ö‡∑è!',
        generating: '‡∑É‡∂ö‡∑É‡∑ä ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...',
        billSummary: '‡∑Ä‡∑í‡∂Ø‡∑î‡∂Ω‡∑í ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫',
        generatedOn: '‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∑Ö ‡∂Ø‡∑í‡∂±‡∂∫',
        verification: '‡∑É‡∂≠‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂±‡∂∫'
      }
    };

    let currentLanguage = 'en';
    let shopCount = 0;

    // ============================================
    // Utility Functions
    // ============================================
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    const t = (key) => translations[currentLanguage]?.[key] || translations['en'][key] || key;

    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('en-LK', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    };

    const saveToStorage = (key, value) => {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.warn('LocalStorage not available');
      }
    };

    const loadFromStorage = (key, defaultValue = null) => {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch (e) {
        return defaultValue;
      }
    };

    // ============================================
    // Shop Management
    // ============================================
    const createShopInput = (shopNumber, units = 0, name = '') => {
      const shopName = name || `${t('shopName')} ${shopNumber}`;
      const div = document.createElement('div');
      div.className = 'shop-input-group';
      div.dataset.shopId = shopNumber;
      div.innerHTML = `
        <button type="button" class="btn btn-outline-danger btn-sm remove-shop-btn" 
                onclick="removeShop(${shopNumber})" 
                aria-label="${t('remove')} ${shopName}"
                ${shopCount <= APP_CONFIG.minShops ? 'disabled' : ''}>
          <i class="bi bi-x-lg"></i>
        </button>
        <div class="row g-2">
          <div class="col-sm-5">
            <label class="form-label small">${t('shopName')}</label>
            <input type="text" class="form-control form-control-sm shop-name" 
                   value="${shopName}" placeholder="${t('shopName')}">
          </div>
          <div class="col-sm-7">
            <label class="form-label small">${t('units')}</label>
            <input type="number" class="form-control shop-unit" 
                   value="${units}" min="0" step="0.01" 
                   placeholder="0" required>
          </div>
        </div>
      `;
      return div;
    };

    const addShop = (units = 0, name = '') => {
      if (shopCount >= APP_CONFIG.maxShops) {
        alert(`Maximum ${APP_CONFIG.maxShops} shops allowed`);
        return;
      }
      shopCount++;
      const shopInput = createShopInput(shopCount, units, name);
      $('#shopInputs').appendChild(shopInput);
      updateRemoveButtons();
    };

    const removeShop = (shopId) => {
      const shopElement = $(`[data-shop-id="${shopId}"]`);
      if (shopElement && shopCount > APP_CONFIG.minShops) {
        shopElement.remove();
        shopCount--;
        renumberShops();
        updateRemoveButtons();
      }
    };

    const renumberShops = () => {
      const shops = $$('.shop-input-group');
      shops.forEach((shop, index) => {
        const newNumber = index + 1;
        shop.dataset.shopId = newNumber;
        const nameInput = shop.querySelector('.shop-name');
        if (nameInput.value.startsWith(t('shopName')) || nameInput.value.match(/^Shop \d+$/)) {
          nameInput.value = `${t('shopName')} ${newNumber}`;
        }
        const removeBtn = shop.querySelector('.remove-shop-btn');
        removeBtn.setAttribute('onclick', `removeShop(${newNumber})`);
      });
      shopCount = shops.length;
    };

    const updateRemoveButtons = () => {
      const removeButtons = $$('.remove-shop-btn');
      removeButtons.forEach(btn => {
        btn.disabled = shopCount <= APP_CONFIG.minShops;
      });
    };

    // ============================================
    // Calculation Logic
    // ============================================
    const validateInputs = () => {
      const totalBill = parseFloat($('#totalBill').value) || 0;
      const fixedCharge = parseFloat($('#fixedCharge').value) || 0;
      const units = [...$$('.shop-unit')].map(input => parseFloat(input.value) || 0);
      const totalUnits = units.reduce((sum, u) => sum + u, 0);

      if (totalBill <= 0) {
        return { valid: false, error: t('errorInvalidBill') };
      }
      if (fixedCharge > totalBill) {
        return { valid: false, error: t('errorFixedCharge') };
      }
      if (totalUnits <= 0) {
        return { valid: false, error: t('errorNoUnits') };
      }

      return { valid: true };
    };

    const calculate = () => {
      const validation = validateInputs();
      if (!validation.valid) {
        showError(validation.error);
        return;
      }

      const totalBill = parseFloat($('#totalBill').value);
      const fixedCharge = parseFloat($('#fixedCharge').value);
      const splitMethod = $('#splitMethod').value;

      const shopInputs = $$('.shop-input-group');
      const shops = [...shopInputs].map(shop => ({
        name: shop.querySelector('.shop-name').value || 'Shop',
        units: parseFloat(shop.querySelector('.shop-unit').value) || 0
      }));

      const totalUnits = shops.reduce((sum, shop) => sum + shop.units, 0);
      const energyCost = totalBill - fixedCharge;
      const unitCost = energyCost / totalUnits;
      const numShops = shops.length;

      let grandTotal = 0;

      // Build results
      let outputHTML = `
        <div class="summary-card">
          <h4><i class="bi bi-bar-chart-fill"></i> ${t('summary')}</h4>
          <div class="row">
            <div class="col-6">
              <div class="small opacity-75">${t('totalUnits')}</div>
              <div class="h5 mb-0">${formatCurrency(totalUnits)}</div>
            </div>
            <div class="col-6">
              <div class="small opacity-75">${t('energyCostPerUnit')}</div>
              <div class="h5 mb-0">${APP_CONFIG.currencySymbol} ${formatCurrency(unitCost)}</div>
            </div>
          </div>
        </div>
      `;

      shops.forEach((shop, i) => {
        const shopEnergyCost = shop.units * unitCost;
        let shopFixedCharge = 0;

        if (splitMethod === 'equal') {
          shopFixedCharge = fixedCharge / numShops;
        } else {
          shopFixedCharge = (shop.units / totalUnits) * fixedCharge;
        }

        const shopTotal = shopEnergyCost + shopFixedCharge;
        grandTotal += shopTotal;

        outputHTML += `
          <div class="shop-block">
            <h5><i class="bi bi-shop"></i> ${shop.name}</h5>
            <div class="row g-2 small">
              <div class="col-6">${t('unitsConsumed')}:</div>
              <div class="col-6 text-end">${formatCurrency(shop.units)}</div>
              
              <div class="col-6">${t('energyCost')}:</div>
              <div class="col-6 text-end">${APP_CONFIG.currencySymbol} ${formatCurrency(shopEnergyCost)}</div>
              
              <div class="col-6">${t('fixedChargeLabel')} (${splitMethod === 'equal' ? t('equal') : t('proportional')}):</div>
              <div class="col-6 text-end">${APP_CONFIG.currencySymbol} ${formatCurrency(shopFixedCharge)}</div>
              
              <div class="col-12"><hr class="my-2"></div>
              
              <div class="col-6"><strong>${t('totalBillLabel')}:</strong></div>
              <div class="col-6 text-end result-highlight">${APP_CONFIG.currencySymbol} ${formatCurrency(shopTotal)}</div>
            </div>
          </div>
        `;
      });

      // Verification row
      outputHTML += `
        <div class="alert alert-info mt-3">
          <i class="bi bi-check-circle"></i> 
          <strong>${t('verification')}:</strong> Sum of all bills = ${APP_CONFIG.currencySymbol} ${formatCurrency(grandTotal)} 
          (Original: ${APP_CONFIG.currencySymbol} ${formatCurrency(totalBill)})
        </div>
      `;

      $('#output').innerHTML = outputHTML;

      // Store calculation data for export
      lastCalculationData = {
        totalBill,
        fixedCharge,
        splitMethod,
        totalUnits,
        unitCost,
        shops: shops.map((shop, i) => {
          const shopEnergyCost = shop.units * unitCost;
          let shopFixedCharge = splitMethod === 'equal' 
            ? fixedCharge / numShops 
            : (shop.units / totalUnits) * fixedCharge;
          return {
            ...shop,
            energyCost: shopEnergyCost,
            fixedCharge: shopFixedCharge,
            total: shopEnergyCost + shopFixedCharge
          };
        })
      };

      // Show export buttons
      $('#exportButtons').classList.add('show');

      // Save last calculation
      saveToStorage(APP_CONFIG.storageKeys.lastCalculation, {
        totalBill,
        fixedCharge,
        splitMethod,
        shops
      });
    };

    const showError = (message) => {
      $('#output').innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle"></i> ${message}
        </div>
      `;
      $('#exportButtons').classList.remove('show');
    };

    // Store last calculation data for export
    let lastCalculationData = null;

    // ============================================
    // Export Functions
    // ============================================
    const generateTextSummary = () => {
      if (!lastCalculationData) return '';
      
      const { totalBill, fixedCharge, splitMethod, shops, totalUnits, unitCost } = lastCalculationData;
      const date = new Date().toLocaleDateString('en-GB');
      
      let text = `‚ö° ${t('billSummary')}\n`;
      text += `üìÖ ${t('generatedOn')}: ${date}\n`;
      text += `${'‚îÄ'.repeat(30)}\n\n`;
      text += `üí∞ ${t('totalBill')}: ${APP_CONFIG.currencySymbol} ${formatCurrency(totalBill)}\n`;
      text += `üìä ${t('totalUnits')}: ${formatCurrency(totalUnits)}\n`;
      text += `üíµ ${t('energyCostPerUnit')}: ${APP_CONFIG.currencySymbol} ${formatCurrency(unitCost)}\n`;
      text += `üîß ${t('fixedCharge')}: ${APP_CONFIG.currencySymbol} ${formatCurrency(fixedCharge)}\n`;
      text += `üìã ${t('splitMethod')}: ${splitMethod === 'equal' ? t('equal') : t('proportional')}\n\n`;
      text += `${'‚îÄ'.repeat(30)}\n`;
      
      shops.forEach((shop, i) => {
        text += `\nüè™ ${shop.name}\n`;
        text += `   ${t('unitsConsumed')}: ${formatCurrency(shop.units)}\n`;
        text += `   ${t('energyCost')}: ${APP_CONFIG.currencySymbol} ${formatCurrency(shop.energyCost)}\n`;
        text += `   ${t('fixedChargeLabel')}: ${APP_CONFIG.currencySymbol} ${formatCurrency(shop.fixedCharge)}\n`;
        text += `   ‚úÖ ${t('totalBillLabel')}: ${APP_CONFIG.currencySymbol} ${formatCurrency(shop.total)}\n`;
      });
      
      text += `\n${'‚îÄ'.repeat(30)}\n`;
      text += `‚úì ${t('verification')}: ${APP_CONFIG.currencySymbol} ${formatCurrency(shops.reduce((sum, s) => sum + s.total, 0))}\n`;
      
      return text;
    };

    const shareOnWhatsApp = () => {
      const text = generateTextSummary();
      if (!text) {
        alert('Please calculate first!');
        return;
      }
      
      const encodedText = encodeURIComponent(text);
      const whatsappUrl = `https://wa.me/?text=${encodedText}`;
      window.open(whatsappUrl, '_blank');
    };

    const copyToClipboard = async () => {
      const text = generateTextSummary();
      if (!text) {
        alert('Please calculate first!');
        return;
      }
      
      try {
        await navigator.clipboard.writeText(text);
        const btn = $('#copyTextBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = `<i class="bi bi-check"></i> ${t('copied')}`;
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-primary');
        
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-primary');
        }, 2000);
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert(t('copied'));
      }
    };

    const exportToPDF = async () => {
      if (!lastCalculationData) {
        alert('Please calculate first!');
        return;
      }

      const btn = $('#exportPdfBtn');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = `<i class="bi bi-hourglass-split"></i> ${t('generating')}`;
      btn.classList.add('btn-loading');
      btn.disabled = true;

      try {
        const { totalBill, fixedCharge, splitMethod, shops, totalUnits, unitCost } = lastCalculationData;
        const date = new Date().toLocaleDateString('en-GB');
        
        // Create PDF content
        const pdfContent = document.createElement('div');
        pdfContent.style.padding = '20px';
        pdfContent.style.fontFamily = 'Arial, sans-serif';
        pdfContent.style.backgroundColor = '#ffffff';
        pdfContent.style.color = '#000000';
        
        pdfContent.innerHTML = `
          <div class="pdf-header">
            <h2 style="color: #667eea; margin: 0;">‚ö° ${t('billSummary')}</h2>
            <p style="color: #666; margin: 5px 0;">${t('generatedOn')}: ${date}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #333;">${t('summary')}</h4>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 8px 0;">${t('totalBill')}:</td>
                <td style="text-align: right; font-weight: bold;">${APP_CONFIG.currencySymbol} ${formatCurrency(totalBill)}</td>
              </tr>
              <tr>
                <td style="padding: 8px 0;">${t('fixedCharge')}:</td>
                <td style="text-align: right;">${APP_CONFIG.currencySymbol} ${formatCurrency(fixedCharge)}</td>
              </tr>
              <tr>
                <td style="padding: 8px 0;">${t('totalUnits')}:</td>
                <td style="text-align: right;">${formatCurrency(totalUnits)}</td>
              </tr>
              <tr>
                <td style="padding: 8px 0;">${t('energyCostPerUnit')}:</td>
                <td style="text-align: right;">${APP_CONFIG.currencySymbol} ${formatCurrency(unitCost)}</td>
              </tr>
              <tr>
                <td style="padding: 8px 0;">${t('splitMethod')}:</td>
                <td style="text-align: right;">${splitMethod === 'equal' ? t('equal') : t('proportional')}</td>
              </tr>
            </table>
          </div>
          
          <h4 style="color: #333;">üè™ ${t('shopUnits')}</h4>
          ${shops.map((shop, i) => `
            <div style="background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
              <h5 style="margin-top: 0; color: #667eea;">${shop.name}</h5>
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <tr>
                  <td style="padding: 5px 0;">${t('unitsConsumed')}:</td>
                  <td style="text-align: right;">${formatCurrency(shop.units)}</td>
                </tr>
                <tr>
                  <td style="padding: 5px 0;">${t('energyCost')}:</td>
                  <td style="text-align: right;">${APP_CONFIG.currencySymbol} ${formatCurrency(shop.energyCost)}</td>
                </tr>
                <tr>
                  <td style="padding: 5px 0;">${t('fixedChargeLabel')}:</td>
                  <td style="text-align: right;">${APP_CONFIG.currencySymbol} ${formatCurrency(shop.fixedCharge)}</td>
                </tr>
                <tr style="border-top: 1px solid #ddd;">
                  <td style="padding: 8px 0; font-weight: bold;">${t('totalBillLabel')}:</td>
                  <td style="text-align: right; font-weight: bold; color: #198754; font-size: 16px;">${APP_CONFIG.currencySymbol} ${formatCurrency(shop.total)}</td>
                </tr>
              </table>
            </div>
          `).join('')}
          
          <div style="background: #d1e7ff; padding: 10px 15px; border-radius: 8px; margin-top: 15px;">
            <strong>‚úì ${t('verification')}:</strong> 
            ${APP_CONFIG.currencySymbol} ${formatCurrency(shops.reduce((sum, s) => sum + s.total, 0))}
          </div>
          
          <div class="pdf-footer">
            <p style="margin: 0;">Generated by Shared Electricity Bill Calculator</p>
            <p style="margin: 5px 0 0 0; font-size: 0.7rem;">github.com/mRasika</p>
          </div>
        `;

        // PDF options
        const opt = {
          margin: 10,
          filename: `electricity-bill-${date.replace(/\//g, '-')}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Generate PDF
        await html2pdf().set(opt).from(pdfContent).save();
        
      } catch (error) {
        console.error('PDF generation error:', error);
        alert('Error generating PDF. Please try again.');
      } finally {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-loading');
        btn.disabled = false;
      }
    };

    // ============================================
    // UI Functions
    // ============================================
    const toggleDarkMode = () => {
      const isDark = $('#darkToggle').checked;
      document.body.classList.toggle('dark-mode', isDark);
      saveToStorage(APP_CONFIG.storageKeys.darkMode, isDark);
    };

    const setLanguage = () => {
      currentLanguage = $('#languageSelect').value;
      saveToStorage(APP_CONFIG.storageKeys.language, currentLanguage);
      updateUILanguage();
    };

    const updateUILanguage = () => {
      // Update title
      $('#title').innerHTML = `<i class="bi bi-lightning-charge"></i> ${t('title')}`;

      // Update all elements with data-i18n attribute
      $$('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.placeholder = t(key);
        } else if (el.tagName === 'OPTION') {
          el.textContent = t(key);
        } else {
          // Preserve icons
          const icon = el.querySelector('i');
          if (icon) {
            el.innerHTML = icon.outerHTML + ' ' + t(key);
          } else {
            el.textContent = t(key);
          }
        }
      });

      // Update shop labels
      renumberShops();
    };

    const resetForm = () => {
      $('#totalBill').value = 2400;
      $('#fixedCharge').value = 500;
      $('#splitMethod').value = 'equal';
      $('#output').innerHTML = '';
      $('#exportButtons').classList.remove('show');
      lastCalculationData = null;
      
      // Reset shops
      $('#shopInputs').innerHTML = '';
      shopCount = 0;
      APP_CONFIG.defaultShops.forEach(shop => addShop(shop.units, shop.name));
    };

    // ============================================
    // Initialization
    // ============================================
    const init = () => {
      // Load saved preferences
      const savedDarkMode = loadFromStorage(APP_CONFIG.storageKeys.darkMode, false);
      const savedLanguage = loadFromStorage(APP_CONFIG.storageKeys.language, 'en');

      // Apply dark mode
      $('#darkToggle').checked = savedDarkMode;
      document.body.classList.toggle('dark-mode', savedDarkMode);

      // Apply language
      currentLanguage = savedLanguage;
      $('#languageSelect').value = savedLanguage;

      // Initialize default shops
      APP_CONFIG.defaultShops.forEach(shop => addShop(shop.units, shop.name));

      // Update UI text
      updateUILanguage();

      // Event listeners
      $('#darkToggle').addEventListener('change', toggleDarkMode);
      $('#languageSelect').addEventListener('change', setLanguage);
      $('#addShopBtn').addEventListener('click', () => addShop());
      $('#resetBtn').addEventListener('click', resetForm);
      $('#printBtn').addEventListener('click', () => window.print());
      
      // Export button listeners
      $('#exportPdfBtn').addEventListener('click', exportToPDF);
      $('#shareWhatsappBtn').addEventListener('click', shareOnWhatsApp);
      $('#copyTextBtn').addEventListener('click', copyToClipboard);

      // Form submission
      $('#calculatorForm').addEventListener('submit', (e) => {
        e.preventDefault();
        calculate();
      });

      // Make removeShop available globally
      window.removeShop = removeShop;
    };

    // Start the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
